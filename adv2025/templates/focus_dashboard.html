<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Êô∫ËÉΩ‰∏ìÊ≥®ÂäõÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .controls-panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-transform: uppercase;
            min-height: 45px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .charts-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 15px;
        }

        .metrics-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            color: #333;
            text-align: center;
        }

        .metric-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .metric-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .metric-progress {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .metric-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .attention-fill {
            background: linear-gradient(90deg, #4CAF50, #81C784);
        }

        .stress-fill {
            background: linear-gradient(90deg, #FF9800, #FFB74D);
        }

        .charts-container {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            color: #333;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .chart-canvas {
            width: 100%;
            height: 220px !important; /* Â¢ûÂä†È´òÂ∫¶ËÆ©Ê≥¢ÂΩ¢Êõ¥Ê∏ÖÊô∞ */
            max-height: 220px !important;
        }
        
        /* Ê∑ªÂä†‰∏ìÊ≥®ËØÑÂàÜÂç°ÁâáÊ†∑Âºè */
        .focus-score-card {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .focus-score-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2196F3;
        }
        
        .focus-score-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2196F3;
        }
        
        .focus-score-trend {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .sidebar {
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 15px;
        }

        .music-panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .music-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .music-info {
            margin-bottom: 15px;
        }

        .music-track {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .music-artist {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .music-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-control {
            margin-bottom: 10px;
        }

        .volume-slider {
            width: 100%;
            margin-top: 10px;
        }

        .break-suggestions {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .break-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .break-recommendation {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #FFD700;
        }

        .break-type {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .break-reason {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .break-activities {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .notifications-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification.warning {
            border-left-color: #FF9800;
        }

        .notification.info {
            border-left-color: #2196F3;
        }

        .notification.break_suggestion {
            border-left-color: #FFD700;
        }

        .notification.force_break {
            border-left-color: #f44336;
        }

        .notification-time {
            font-size: 0.8em;
            opacity: 0.7;
            float: right;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
            }
            
            .notifications-panel {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .metrics-overview {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
        }

        .break-recommendation {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #FFD700;
        }

        .break-recommendation.high-urgency {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .break-recommendation.medium-urgency {
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .break-recommendation.low-urgency {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .break-type {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .break-duration, .break-urgency, .break-confidence {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .break-reason {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
            font-style: italic;
        }

        .break-activities {
            font-size: 0.85em;
            margin-bottom: 15px;
        }

        .break-activities ul {
            margin: 5px 0 0 20px;
            padding: 0;
        }

        .break-activities li {
            margin-bottom: 3px;
        }

        .music-reason {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- ËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div class="connection-status disconnected" id="connectionStatus">
        <span id="connectionText">ËøûÊé•‰∏≠...</span>
    </div>

    <div class="container">
        <!-- Â§¥ÈÉ® -->
        <div class="header">
            <h1>üß† Êô∫ËÉΩ‰∏ìÊ≥®ÂäõÁÆ°ÁêÜÁ≥ªÁªü</h1>
            <p>AIÈ©±Âä®ÁöÑ‰∏ìÊ≥®ÂäõËÆ≠ÁªÉ‰∏éËÆ§Áü•‰ºòÂåñÂπ≥Âè∞</p>
        </div>

        <!-- ‰ºöËØù‰ø°ÊÅØ -->
        <div class="session-info" id="sessionInfo">
            <div class="info-item">
                <div class="info-label">‰ºöËØùÁä∂ÊÄÅ</div>
                <div class="info-value" id="sessionStatus">Êú™ÂºÄÂßã</div>
            </div>
            <div class="info-item">
                <div class="info-label">Â∑≤Áî®Êó∂Èó¥</div>
                <div class="info-value" id="elapsedTime">00:00:00</div>
            </div>
            <div class="info-item">
                <div class="info-label">ÁõÆÊ†áÊó∂Èó¥</div>
                <div class="info-value" id="targetTime">--:-- ~ --:--</div>
            </div>
            <div class="info-item">
                <div class="info-label">‰∏ìÊ≥®ËØÑÂàÜ</div>
                <div class="info-value" id="focusScore">--</div>
            </div>
        </div>

        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="controls-panel">
            <div class="controls-grid">
                <button class="btn btn-primary" onclick="window.location.href='/setup'">
                    üöÄ Êñ∞Âª∫‰ºöËØù
                </button>
                <button class="btn btn-secondary" id="pauseBtn" onclick="pauseSession()" disabled>
                    ‚è∏Ô∏è ÊöÇÂÅú‰ºöËØù
                </button>
                <button class="btn btn-secondary" id="resumeBtn" onclick="resumeSession()" disabled style="display:none;">
                    ‚ñ∂Ô∏è ÊÅ¢Â§ç‰ºöËØù
                </button>
                <button class="btn btn-warning" id="takeBreakBtn" onclick="takeBreak()" disabled>
                    ‚òï ‰ºëÊÅØ5ÂàÜÈíü
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopSession()" disabled>
                    üõë ÁªìÊùü‰ºöËØù
                </button>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
        <div class="main-content">
            <!-- ÂõæË°®ÂíåÊåáÊ†áÂå∫Âüü -->
            <div class="charts-section">
                <!-- ËÆ§Áü•ÊåáÊ†áÊ¶ÇËßà -->
                <div class="metrics-overview">
                    <div class="metric-card">
                        <div class="metric-title">üéØ ‰∏ìÊ≥®Â∫¶</div>
                        <div class="metric-value" id="attentionValue">0%</div>
                        <div class="metric-progress">
                            <div class="metric-fill attention-fill" id="attentionBar" style="width: 0%"></div>
                        </div>
                        <div id="attentionTrend">Á®≥ÂÆö</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">‚ö° ËÆ§Áü•ÂéãÂäõ</div>
                        <div class="metric-value" id="stressValue">0%</div>
                        <div class="metric-progress">
                            <div class="metric-fill stress-fill" id="stressBar" style="width: 0%"></div>
                        </div>
                        <div id="stressTrend">Á®≥ÂÆö</div>
                    </div>
                </div>

                <!-- ËÑëÁîµÊ≥¢ÂΩ¢Âõæ -->
                <div class="charts-container">
                    <div class="chart-title">üß† ÂÆûÊó∂ËÑëÁîµÊ≥¢ÂΩ¢ (T7/T8ÁîµÊûÅ)</div>
                    <canvas class="chart-canvas" id="eegChart"></canvas>
                </div>

                <!-- ËÆ§Áü•ÊåáÊ†áÂéÜÂè≤Ë∂ãÂäøÂõæ -->
                <div class="charts-container">
                    <div class="chart-title">üìà ËÆ§Áü•ÊåáÊ†áÂéÜÂè≤Ë∂ãÂäø</div>
                    <canvas class="chart-canvas" id="metricsChart"></canvas>
                </div>
            </div>

            <!-- ‰æßËæπÊ†è -->
            <div class="sidebar">
                <!-- Èü≥‰πêÊé®ËçêÈù¢Êùø -->
                <div class="music-panel" id="musicPanel">
                    <div class="music-title">üéµ Êô∫ËÉΩÈü≥‰πêÊé®Ëçê</div>
                    <div class="music-info" id="musicInfo">
                        <div class="music-track" id="musicTrack">Á≠âÂæÖÊé®Ëçê...</div>
                        <div class="music-artist" id="musicArtist"></div>
                        <div class="music-reason" id="musicReason"></div>
                    </div>
                    <div class="music-controls">
                        <button class="btn btn-primary" id="playMusicBtn" onclick="startMusic()">
                            ‚ñ∂Ô∏è Êí≠Êîæ
                        </button>
                        <button class="btn btn-secondary" id="stopMusicBtn" onclick="stopMusic()">
                            ‚èπÔ∏è ÂÅúÊ≠¢
                        </button>
                    </div>
                    <div class="volume-control">
                        <label>Êé®ËçêÈü≥Èáè: <span id="volumeLevel">50%</span></label>
                        <input type="range" class="volume-slider" id="volumeSlider" 
                               min="0" max="100" value="50" onchange="updateVolume()">
                    </div>
                </div>

                <!-- ‰ºëÊÅØÂª∫ËÆÆÈù¢Êùø -->
                <div class="break-suggestions" id="breakPanel">
                    <div class="break-title">üí° Êô∫ËÉΩ‰ºëÊÅØÂª∫ËÆÆ</div>
                    <div id="breakContent">
                        <p style="text-align: center; opacity: 0.8;">ÊöÇÊó†‰ºëÊÅØÂª∫ËÆÆ</p>
                    </div>
                </div>

                <!-- ÈÄöÁü•Èù¢Êùø -->
                <div class="notifications-panel">
                    <div class="break-title">üì¢ Á≥ªÁªüÈÄöÁü•</div>
                    <div id="notificationsList">
                        <!-- ÈÄöÁü•Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÊ∑ªÂä† -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptÂ∫ì -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        const socket = io();
        let eegChart;
        let sessionStartTime = null;
        let currentSession = null;
        let notifications = []; // Ê∑ªÂä†ÈÄöÁü•Êï∞ÁªÑ
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadStatus();
        });
        
        // ÂàùÂßãÂåñÂõæË°®
        function initChart() {
            const ctx = document.getElementById('eegChart').getContext('2d');
            
            eegChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'T7 (Â∑¶ËÑë)',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'T8 (Âè≥ËÑë)',
                            data: [],
                            borderColor: '#FF5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ÁîµÂéã (ŒºV)'
                            }
                        }
                    },
                    animation: false
                }
            });
            
            // ÂàùÂßãÂåñËÆ§Áü•ÊåáÊ†áÂõæË°®
            initMetricsChart();
        }
        
        // ÂàùÂßãÂåñËÆ§Áü•ÊåáÊ†áÂõæË°®
        function initMetricsChart() {
            const metricsCtx = document.getElementById('metricsChart').getContext('2d');
            
            window.metricsChart = new Chart(metricsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'üéØ ‰∏ìÊ≥®Â∫¶',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        },
                        {
                            label: '‚ö° ËÆ§Áü•ÂéãÂäõ',
                            data: [],
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = (context.parsed.y * 100).toFixed(1);
                                    return context.dataset.label + ': ' + value + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Êó∂Èó¥ (Áßí)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Ê∞¥Âπ≥ (0-1)'
                            },
                            min: 0,
                            max: 1,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 300
                    }
                }
            });
        }
        
        // Âä†ËΩΩÁä∂ÊÄÅ
        function loadStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateUI(data);
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁä∂ÊÄÅÂ§±Ë¥•:', error);
                });
        }
        
        // Êõ¥Êñ∞UI - ÂåπÈÖçÂêéÁ´ØÊï∞ÊçÆÊ†ºÂºè
        function updateUI(status) {
            // Êõ¥Êñ∞‰ºöËØùÁä∂ÊÄÅ
            if (status.running) {
                document.getElementById('sessionStatus').textContent = 'ËøõË°å‰∏≠';
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('takeBreakBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                
                // Â¶ÇÊûúÊ≤°Êúâ‰ºöËØùÂºÄÂßãÊó∂Èó¥‰∏î‰ºöËØùÊ≠£Âú®ËøêË°åÔºåËÆæÁΩÆÂºÄÂßãÊó∂Èó¥
                if (!sessionStartTime) {
                    sessionStartTime = new Date();
                }
            } else {
                document.getElementById('sessionStatus').textContent = 'Êú™ÂºÄÂßã';
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('takeBreakBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                sessionStartTime = null;
            }
            
            // Êõ¥Êñ∞‰ºöËØùÈÖçÁΩÆ‰ø°ÊÅØ
            if (status.session_config) {
                currentSession = status.session_config;
                document.getElementById('targetTime').textContent = 
                    `${currentSession.min_duration}:00 ~ ${currentSession.max_duration}:00`;
            }
            
            // ‰ºòÂÖà‰ΩøÁî®ÂêéÁ´ØÊèê‰æõÁöÑÊó∂ÈïøÊï∞ÊçÆ
            if (status.status && status.status.duration !== undefined) {
                updateElapsedTime(status.status.duration);
            }
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊï∞ÊçÆ
            if (status.status) {
                // Êõ¥Êñ∞‰∏ìÊ≥®Â∫¶
                const attentionPercent = Math.round((status.status.attention || 0) * 100);
                document.getElementById('attentionValue').textContent = attentionPercent + '%';
                document.getElementById('attentionBar').style.width = attentionPercent + '%';
                
                // Êõ¥Êñ∞ÂéãÂäõ
                const stressPercent = Math.round((status.status.stress || 0) * 100);
                document.getElementById('stressValue').textContent = stressPercent + '%';
                document.getElementById('stressBar').style.width = stressPercent + '%';
                
                // Êõ¥Êñ∞‰∏ìÊ≥®ËØÑÂàÜÔºàÂü∫‰∫éÊ≥®ÊÑèÂäõÂíåÂéãÂäõËÆ°ÁÆóÁªºÂêàËØÑÂàÜÔºâ
                const focusScore = Math.round(((status.status.attention || 0) * 0.7 + (1 - (status.status.stress || 0)) * 0.3) * 100);
                document.getElementById('focusScore').textContent = focusScore + '%';
            }
        }
        
        // Áªü‰∏ÄÁöÑÊó∂Èó¥Êõ¥Êñ∞ÂáΩÊï∞
        function updateElapsedTime(durationInSeconds) {
            const duration = Math.floor(durationInSeconds);
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;
            
            document.getElementById('elapsedTime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Êõ¥Êñ∞ÂõæË°® - ÂåπÈÖçÂêéÁ´ØÊï∞ÊçÆÊ†ºÂºè
        function updateChart(eegData) {
            if (!eegData || eegData.length === 0) return;
            
            // ÊòæÁ§∫ÊúÄËøë30‰∏™Êï∞ÊçÆÁÇπ
            const maxPoints = 30;
            const recentData = eegData.slice(-maxPoints);
            
            const t7Data = recentData.map(d => d.T7);
            const t8Data = recentData.map(d => d.T8);
            const labels = recentData.map((d, i) => i);
            
            eegChart.data.labels = labels;
            eegChart.data.datasets[0].data = t7Data;
            eegChart.data.datasets[1].data = t8Data;
            eegChart.update('none');
        }
        
        // Êõ¥Êñ∞ÊåáÊ†á - ÂåπÈÖçÂêéÁ´ØÊï∞ÊçÆÊ†ºÂºèÂπ∂Ê∑ªÂä†Ë∂ãÂäøÂàÜÊûê
        function updateMetrics(metricsData) {
            if (!metricsData || metricsData.length === 0) return;
            
            const latest = metricsData[metricsData.length - 1];
            
            // Êõ¥Êñ∞‰∏ìÊ≥®Â∫¶
            const attentionPercent = Math.round((latest.attention || 0) * 100);
            document.getElementById('attentionValue').textContent = attentionPercent + '%';
            document.getElementById('attentionBar').style.width = attentionPercent + '%';
            
            // Êõ¥Êñ∞ÂéãÂäõ
            const stressPercent = Math.round((latest.stress || 0) * 100);
            document.getElementById('stressValue').textContent = stressPercent + '%';
            document.getElementById('stressBar').style.width = stressPercent + '%';
            
            // Êõ¥Êñ∞‰∏ìÊ≥®ËØÑÂàÜ
            const focusScore = Math.round(((latest.attention || 0) * 0.7 + (1 - (latest.stress || 0)) * 0.3) * 100);
            document.getElementById('focusScore').textContent = focusScore + '%';
            
            // ËÆ°ÁÆóÂπ∂ÊòæÁ§∫Ë∂ãÂäø
            updateTrends(metricsData);
            
            // Êõ¥Êñ∞ËÆ§Áü•ÊåáÊ†áÂõæË°®
            updateMetricsChart(metricsData);
        }
        
        // Êñ∞Â¢ûÔºöÊõ¥Êñ∞Ë∂ãÂäøÊòæÁ§∫
        function updateTrends(metricsData) {
            if (metricsData.length < 10) return; // ÈúÄË¶ÅË∂≥Â§üÁöÑÊï∞ÊçÆÁÇπ
            
            const recent = metricsData.slice(-10);
            const older = metricsData.slice(-20, -10);
            
            if (older.length === 0) return;
            
            // ËÆ°ÁÆóÊ≥®ÊÑèÂäõË∂ãÂäø
            const recentAttention = recent.reduce((sum, d) => sum + (d.attention || 0), 0) / recent.length;
            const olderAttention = older.reduce((sum, d) => sum + (d.attention || 0), 0) / older.length;
            const attentionTrend = recentAttention - olderAttention;
            
            // ËÆ°ÁÆóÂéãÂäõË∂ãÂäø
            const recentStress = recent.reduce((sum, d) => sum + (d.stress || 0), 0) / recent.length;
            const olderStress = older.reduce((sum, d) => sum + (d.stress || 0), 0) / older.length;
            const stressTrend = recentStress - olderStress;
            
            // Êõ¥Êñ∞Ë∂ãÂäøÊòæÁ§∫
            document.getElementById('attentionTrend').textContent = 
                attentionTrend > 0.05 ? '‚ÜóÔ∏è ‰∏äÂçá' : 
                attentionTrend < -0.05 ? '‚ÜòÔ∏è ‰∏ãÈôç' : '‚û°Ô∏è Á®≥ÂÆö';
                
            document.getElementById('stressTrend').textContent = 
                stressTrend > 0.05 ? '‚ÜóÔ∏è ‰∏äÂçá' : 
                stressTrend < -0.05 ? '‚ÜòÔ∏è ‰∏ãÈôç' : '‚û°Ô∏è Á®≥ÂÆö';
        }
        
        // Êñ∞Â¢ûÔºöÊõ¥Êñ∞ËÆ§Áü•ÊåáÊ†áÂõæË°®
        function updateMetricsChart(metricsData) {
            if (!window.metricsChart || metricsData.length === 0) return;
            
            // ÊòæÁ§∫ÊúÄËøë60‰∏™Êï∞ÊçÆÁÇπÔºàÁ∫¶1ÂàÜÈíüÔºâ
            const maxPoints = 60;
            const recentData = metricsData.slice(-maxPoints);
            
            const labels = recentData.map((d, i) => i);
            const attentionData = recentData.map(d => d.attention || 0);
            const stressData = recentData.map(d => d.stress || 0);
            
            window.metricsChart.data.labels = labels;
            window.metricsChart.data.datasets[0].data = attentionData;
            window.metricsChart.data.datasets[1].data = stressData;
            window.metricsChart.update('none');
        }
        
        // Êõ¥Êñ∞ÈÄöÁü•
        function updateNotifications(newNotifications) {
            if (!newNotifications) return;
            
            // ÂêàÂπ∂Êñ∞ÈÄöÁü•
            notifications = [...notifications, ...newNotifications];
            
            const notificationsList = document.getElementById('notificationsList');
            
            // ÊòæÁ§∫ÊúÄÊñ∞10Êù°ÈÄöÁü•
            const recentNotifications = notifications.slice(-10);
            notificationsList.innerHTML = '';
            
            recentNotifications.forEach(notification => {
                const notificationEl = document.createElement('div');
                notificationEl.className = `notification ${notification.type || 'info'}`;
                
                const timeText = new Date(notification.timestamp * 1000).toLocaleTimeString();
                
                notificationEl.innerHTML = `
                    <div class="notification-time">${timeText}</div>
                    <div>${notification.message}</div>
                `;
                
                notificationsList.appendChild(notificationEl);
            });
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            notificationsList.scrollTop = notificationsList.scrollHeight;
        }
        
        // ‰ºöËØùÊéßÂà∂ÂáΩÊï∞ - Ê∑ªÂä†Áº∫Â§±ÁöÑAPIË∞ÉÁî®
        function pauseSession() {
            fetch('/api/pause_session', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('pauseBtn').style.display = 'none';
                        document.getElementById('resumeBtn').style.display = 'block';
                        showMessage('‰ºöËØùÂ∑≤ÊöÇÂÅú', 'info');
                    } else {
                        showMessage('ÊöÇÂÅúÂ§±Ë¥•: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('ÊöÇÂÅúÂ§±Ë¥•: ' + error.message, 'error');
                });
        }
        
        function resumeSession() {
            fetch('/api/resume_session', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('pauseBtn').style.display = 'block';
                        document.getElementById('resumeBtn').style.display = 'none';
                        showMessage('‰ºöËØùÂ∑≤ÊÅ¢Â§ç', 'success');
                    } else {
                        showMessage('ÊÅ¢Â§çÂ§±Ë¥•: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('ÊÅ¢Â§çÂ§±Ë¥•: ' + error.message, 'error');
                });
        }
        
        function stopSession() {
            if (confirm('Á°ÆÂÆöË¶ÅÁªìÊùüÂΩìÂâç‰ºöËØùÂêóÔºü')) {
                fetch('/api/stop_session', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('‰ºöËØùÂ∑≤ÂÅúÊ≠¢', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showMessage('ÂÅúÊ≠¢Â§±Ë¥•: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showMessage('ÂÅúÊ≠¢Â§±Ë¥•: ' + error.message, 'error');
                    });
            }
        }
        
        function takeBreak() {
            const duration = prompt('ËØ∑ËæìÂÖ•‰ºëÊÅØÊó∂Èó¥ÔºàÂàÜÈíüÔºâ:', '5');
            if (duration && !isNaN(duration)) {
                fetch('/api/take_break', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: parseInt(duration) })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('‰ºëÊÅØËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
                });
            }
        }
        
        // Èü≥‰πêÊéßÂà∂ÂáΩÊï∞ - Ê∑ªÂä†Áº∫Â§±ÁöÑAPIË∞ÉÁî®
        function startMusic() {
            fetch('/api/start_music', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•: ' + error.message, 'error');
                });
        }
        
        function stopMusic() {
            fetch('/api/stop_music', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('Èü≥‰πêÂÅúÊ≠¢Â§±Ë¥•: ' + error.message, 'error');
                });
        }
        
        function updateVolume() {
            const volume = document.getElementById('volumeSlider').value;
            document.getElementById('volumeLevel').textContent = volume + '%';
        }
        
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showMessage(message, type) {
            // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÈÄöÁü•ÂàóË°®
            const notification = {
                message: message,
                type: type,
                timestamp: Date.now() / 1000
            };
            updateNotifications([notification]);
        }
        
        function updateTimer() {
            if (sessionStartTime) {
                const now = new Date();
                const elapsed = Math.floor((now - sessionStartTime) / 1000);
                
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('elapsedTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Socket.IO ‰∫ã‰ª∂Â§ÑÁêÜ - ‰ΩøÁî®ÂêéÁ´ØÂÆûÈôÖÁöÑ‰∫ã‰ª∂ÂêçÁß∞
        socket.on('connect', function() {
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionText').textContent = '‚úÖ Â∑≤ËøûÊé•';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionText').textContent = '‚ùå ËøûÊé•Êñ≠ÂºÄ';
        });
        
        // ‰øÆÊîπ‰∫ã‰ª∂ÂêçÁß∞‰ª•ÂåπÈÖçÂêéÁ´Ø
        socket.on('data_update', function(data) {
            updateChart(data.eeg_data);
            updateMetrics(data.metrics_data);
            
            // Â§ÑÁêÜ‰ºëÊÅØÂª∫ËÆÆ
            if (data.break_suggestion) {
                updateBreakSuggestion(data.break_suggestion);
            }
            
            // Â§ÑÁêÜÈü≥‰πêÊé®Ëçê
            if (data.music_status) {
                updateMusicRecommendation(data.music_status);
            }
            
            // Â§ÑÁêÜÁä∂ÊÄÅÊõ¥Êñ∞
            if (data.status) {
                // Êõ¥Êñ∞‰ºöËØùÊó∂Èïø
                if (data.status.duration) {
                    updateElapsedTime(data.status.duration);
                }
            }
        });
        
        // Êñ∞Â¢ûÔºöÊõ¥Êñ∞‰ºëÊÅØÂª∫ËÆÆÊòæÁ§∫
        function updateBreakSuggestion(suggestion) {
            const breakContent = document.getElementById('breakContent');
            
            if (suggestion) {
                const urgencyClass = suggestion.urgency >= 4 ? 'high-urgency' : 
                                   suggestion.urgency >= 3 ? 'medium-urgency' : 'low-urgency';
                
                breakContent.innerHTML = `
                    <div class="break-recommendation ${urgencyClass}">
                        <div class="break-type">üí° ${getBreakTypeText(suggestion.type)}</div>
                        <div class="break-duration">‚è±Ô∏è Âª∫ËÆÆÊó∂Èïø: ${suggestion.duration} ÂàÜÈíü</div>
                        <div class="break-reason">üìã ÂéüÂõ†: ${suggestion.reason}</div>
                        <div class="break-urgency">‚ö†Ô∏è Á¥ßÊÄ•Á®ãÂ∫¶: ${suggestion.urgency}/5</div>
                        <div class="break-activities">
                            <strong>Âª∫ËÆÆÊ¥ªÂä®:</strong>
                            <ul>
                                ${suggestion.activities.map(activity => `<li>${activity}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="break-confidence">ÂèØ‰ø°Â∫¶: ${(suggestion.confidence * 100).toFixed(0)}%</div>
                        <button class="btn btn-warning" onclick="acceptBreakSuggestion(${suggestion.duration})">
                            Êé•ÂèóÂª∫ËÆÆ
                        </button>
                    </div>
                `;
                
                // Ê∑ªÂä†ÈÄöÁü•
                showMessage(`üí° ‰ºëÊÅØÂª∫ËÆÆ: ${suggestion.reason}`, 'break_suggestion');
            }
        }
        
        // Êñ∞Â¢ûÔºöËé∑Âèñ‰ºëÊÅØÁ±ªÂûãÊñáÊú¨
        function getBreakTypeText(type) {
            const typeMap = {
                'micro_break': 'ÂæÆ‰ºëÊÅØ',
                'short_break': 'Áü≠‰ºëÊÅØ', 
                'long_break': 'Èïø‰ºëÊÅØ',
                'power_nap': 'Â∞èÊÜ©'
            };
            return typeMap[type] || type;
        }
        
        // Êñ∞Â¢ûÔºöÊé•Âèó‰ºëÊÅØÂª∫ËÆÆ
        function acceptBreakSuggestion(duration) {
            if (confirm(`Á°ÆÂÆöË¶Å‰ºëÊÅØ ${duration} ÂàÜÈíüÂêóÔºü`)) {
                fetch('/api/take_break', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: duration })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('‰ºëÊÅØËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
                });
            }
        }
        
        // Êñ∞Â¢ûÔºöÊõ¥Êñ∞Èü≥‰πêÊé®ËçêÊòæÁ§∫
        function updateMusicRecommendation(musicStatus) {
            if (musicStatus && musicStatus.recommendation) {
                const recommendation = musicStatus.recommendation;
                
                document.getElementById('musicTrack').textContent = 
                    recommendation.tracks && recommendation.tracks.length > 0 ? 
                    recommendation.tracks[0].title : 'ÊöÇÊó†Êé®Ëçê';
                    
                document.getElementById('musicArtist').textContent = 
                    recommendation.tracks && recommendation.tracks.length > 0 ? 
                    recommendation.tracks[0].artist : '';
                    
                document.getElementById('musicReason').textContent = 
                    recommendation.reason || '';
                
                // Êõ¥Êñ∞Êé®ËçêÈü≥Èáè
                if (recommendation.adaptive_volume !== undefined) {
                    const volumePercent = Math.round(recommendation.adaptive_volume * 100);
                    document.getElementById('volumeSlider').value = volumePercent;
                    document.getElementById('volumeLevel').textContent = volumePercent + '%';
                }
            }
        }
        
        // Êñ∞Â¢ûÔºöÊé•Âèó‰ºëÊÅØÂª∫ËÆÆ
        function acceptBreakSuggestion(duration) {
            if (confirm(`Á°ÆÂÆöË¶Å‰ºëÊÅØ ${duration} ÂàÜÈíüÂêóÔºü`)) {
                fetch('/api/take_break', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: duration })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('‰ºëÊÅØËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
                });
            }
        }
        
        // ÂÆöÊó∂Âô®
        setInterval(updateTimer, 1000);
        setInterval(loadStatus, 30000); // ÊØè30ÁßíÂà∑Êñ∞Áä∂ÊÄÅ
    </script>
</body>
</html>