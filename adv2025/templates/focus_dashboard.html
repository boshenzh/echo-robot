<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§  æ™ºèƒ½ä¸“æ³¨åŠ›ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .controls-panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-transform: uppercase;
            min-height: 45px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .charts-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 15px;
        }

        .metrics-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            color: #333;
            text-align: center;
        }

        .metric-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .metric-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .metric-progress {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .metric-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .attention-fill {
            background: linear-gradient(90deg, #4CAF50, #81C784);
        }

        .stress-fill {
            background: linear-gradient(90deg, #FF9800, #FFB74D);
        }

        .charts-container {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            color: #333;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .chart-canvas {
            width: 100%;
            height: 220px !important; /* å¢åŠ é«˜åº¦è®©æ³¢å½¢æ›´æ¸…æ™° */
            max-height: 220px !important;
        }
        
        /* æ·»åŠ ä¸“æ³¨è¯„åˆ†å¡ç‰‡æ ·å¼ */
        .focus-score-card {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .focus-score-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2196F3;
        }
        
        .focus-score-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2196F3;
        }
        
        .focus-score-trend {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .sidebar {
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 15px;
        }

        .music-panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .music-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .music-info {
            margin-bottom: 15px;
        }

        .music-track {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .music-artist {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .music-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-control {
            margin-bottom: 10px;
        }

        .volume-slider {
            width: 100%;
            margin-top: 10px;
        }

        .break-suggestions {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .break-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .break-recommendation {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #FFD700;
        }

        .break-type {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .break-reason {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .break-activities {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .notifications-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification.warning {
            border-left-color: #FF9800;
        }

        .notification.info {
            border-left-color: #2196F3;
        }

        .notification.break_suggestion {
            border-left-color: #FFD700;
        }

        .notification.force_break {
            border-left-color: #f44336;
        }

        .notification-time {
            font-size: 0.8em;
            opacity: 0.7;
            float: right;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
            }
            
            .notifications-panel {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .metrics-overview {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
        }

        .break-recommendation {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #FFD700;
        }

        .break-recommendation.high-urgency {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .break-recommendation.medium-urgency {
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .break-recommendation.low-urgency {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .break-type {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .break-duration, .break-urgency, .break-confidence {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .break-reason {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
            font-style: italic;
        }

        .break-activities {
            font-size: 0.85em;
            margin-bottom: 15px;
        }

        .break-activities ul {
            margin: 5px 0 0 20px;
            padding: 0;
        }

        .break-activities li {
            margin-bottom: 3px;
        }

        .music-reason {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-status disconnected" id="connectionStatus">
        <span id="connectionText">è¿æ¥ä¸­...</span>
    </div>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ§  æ™ºèƒ½ä¸“æ³¨åŠ›ç®¡ç†ç³»ç»Ÿ</h1>
            <p>AIé©±åŠ¨çš„ä¸“æ³¨åŠ›è®­ç»ƒä¸è®¤çŸ¥ä¼˜åŒ–å¹³å°</p>
        </div>

        <!-- ä¼šè¯ä¿¡æ¯ -->
        <div class="session-info" id="sessionInfo">
            <div class="info-item">
                <div class="info-label">ä¼šè¯çŠ¶æ€</div>
                <div class="info-value" id="sessionStatus">æœªå¼€å§‹</div>
            </div>
            <div class="info-item">
                <div class="info-label">å·²ç”¨æ—¶é—´</div>
                <div class="info-value" id="elapsedTime">00:00:00</div>
            </div>
            <div class="info-item">
                <div class="info-label">ç›®æ ‡æ—¶é—´</div>
                <div class="info-value" id="targetTime">--:-- ~ --:--</div>
            </div>
            <div class="info-item">
                <div class="info-label">ä¸“æ³¨è¯„åˆ†</div>
                <div class="info-value" id="focusScore">--</div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls-panel">
            <div class="controls-grid">
                <button class="btn btn-primary" onclick="window.location.href='/setup'">
                    ğŸš€ æ–°å»ºä¼šè¯
                </button>
                <button class="btn btn-secondary" id="pauseBtn" onclick="pauseSession()" disabled>
                    â¸ï¸ æš‚åœä¼šè¯
                </button>
                <button class="btn btn-secondary" id="resumeBtn" onclick="resumeSession()" disabled style="display:none;">
                    â–¶ï¸ æ¢å¤ä¼šè¯
                </button>
                <button class="btn btn-warning" id="takeBreakBtn" onclick="takeBreak()" disabled>
                    â˜• ä¼‘æ¯5åˆ†é’Ÿ
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopSession()" disabled>
                    ğŸ›‘ ç»“æŸä¼šè¯
                </button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å›¾è¡¨å’ŒæŒ‡æ ‡åŒºåŸŸ -->
            <div class="charts-section">
                <!-- è®¤çŸ¥æŒ‡æ ‡æ¦‚è§ˆ -->
                <div class="metrics-overview">
                    <div class="metric-card">
                        <div class="metric-title">ğŸ¯ ä¸“æ³¨åº¦</div>
                        <div class="metric-value" id="attentionValue">0%</div>
                        <div class="metric-progress">
                            <div class="metric-fill attention-fill" id="attentionBar" style="width: 0%"></div>
                        </div>
                        <div id="attentionTrend">ç¨³å®š</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">âš¡ è®¤çŸ¥å‹åŠ›</div>
                        <div class="metric-value" id="stressValue">0%</div>
                        <div class="metric-progress">
                            <div class="metric-fill stress-fill" id="stressBar" style="width: 0%"></div>
                        </div>
                        <div id="stressTrend">ç¨³å®š</div>
                    </div>
                </div>

                <!-- è„‘ç”µæ³¢å½¢å›¾ -->
                <div class="charts-container">
                    <div class="chart-title">ğŸ§  å®æ—¶è„‘ç”µæ³¢å½¢ (T7/T8ç”µæ)</div>
                    <canvas class="chart-canvas" id="eegChart"></canvas>
                </div>

                <!-- è®¤çŸ¥æŒ‡æ ‡å†å²è¶‹åŠ¿å›¾ -->
                <div class="charts-container">
                    <div class="chart-title">ğŸ“ˆ è®¤çŸ¥æŒ‡æ ‡å†å²è¶‹åŠ¿</div>
                    <canvas class="chart-canvas" id="metricsChart"></canvas>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <!-- éŸ³ä¹æ¨èé¢æ¿ -->
                <div class="music-panel" id="musicPanel">
                    <div class="music-title">ğŸµ æ™ºèƒ½éŸ³ä¹æ¨è</div>
                    <div class="music-info" id="musicInfo">
                        <div class="music-track" id="musicTrack">ç­‰å¾…æ¨è...</div>
                        <div class="music-artist" id="musicArtist"></div>
                        <div class="music-reason" id="musicReason"></div>
                    </div>
                    <div class="music-controls">
                        <button class="btn btn-primary" id="playMusicBtn" onclick="startMusic()">
                            â–¶ï¸ æ’­æ”¾
                        </button>
                        <button class="btn btn-secondary" id="stopMusicBtn" onclick="stopMusic()">
                            â¹ï¸ åœæ­¢
                        </button>
                    </div>
                    <div class="volume-control">
                        <label>æ¨èéŸ³é‡: <span id="volumeLevel">50%</span></label>
                        <input type="range" class="volume-slider" id="volumeSlider" 
                               min="0" max="100" value="50" onchange="updateVolume()">
                    </div>
                </div>

                <!-- ä¼‘æ¯å»ºè®®é¢æ¿ -->
                <div class="break-suggestions" id="breakPanel">
                    <div class="break-title">ğŸ’¡ æ™ºèƒ½ä¼‘æ¯å»ºè®®</div>
                    <div id="breakContent">
                        <p style="text-align: center; opacity: 0.8;">æš‚æ— ä¼‘æ¯å»ºè®®</p>
                    </div>
                </div>

                <!-- é€šçŸ¥é¢æ¿ -->
                <div class="notifications-panel">
                    <div class="break-title">ğŸ“¢ ç³»ç»Ÿé€šçŸ¥</div>
                    <div id="notificationsList">
                        <!-- é€šçŸ¥å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        const socket = io();
        let eegChart;
        let sessionStartTime = null;
        let currentSession = null;
        let notifications = []; // æ·»åŠ é€šçŸ¥æ•°ç»„
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadStatus();
        });
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('eegChart').getContext('2d');
            
            eegChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'T7 (å·¦è„‘)',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'T8 (å³è„‘)',
                            data: [],
                            borderColor: '#FF5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ç”µå‹ (Î¼V)'
                            }
                        }
                    },
                    animation: false
                }
            });
            
            // åˆå§‹åŒ–è®¤çŸ¥æŒ‡æ ‡å›¾è¡¨
            initMetricsChart();
        }
        
        // åˆå§‹åŒ–è®¤çŸ¥æŒ‡æ ‡å›¾è¡¨
        function initMetricsChart() {
            const metricsCtx = document.getElementById('metricsChart').getContext('2d');
            
            window.metricsChart = new Chart(metricsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ğŸ¯ ä¸“æ³¨åº¦',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'âš¡ è®¤çŸ¥å‹åŠ›',
                            data: [],
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = (context.parsed.y * 100).toFixed(1);
                                    return context.dataset.label + ': ' + value + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´ (ç§’)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ°´å¹³ (0-1)'
                            },
                            min: 0,
                            max: 1,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 300
                    }
                }
            });
        }
        
        // åŠ è½½çŠ¶æ€
        function loadStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateUI(data);
                })
                .catch(error => {
                    console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        // æ›´æ–°UI - åŒ¹é…åç«¯æ•°æ®æ ¼å¼
        function updateUI(status) {
            // æ›´æ–°ä¼šè¯çŠ¶æ€
            if (status.running) {
                document.getElementById('sessionStatus').textContent = 'è¿›è¡Œä¸­';
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('takeBreakBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                
                // å¦‚æœæ²¡æœ‰ä¼šè¯å¼€å§‹æ—¶é—´ä¸”ä¼šè¯æ­£åœ¨è¿è¡Œï¼Œè®¾ç½®å¼€å§‹æ—¶é—´
                if (!sessionStartTime) {
                    sessionStartTime = new Date();
                }
            } else {
                document.getElementById('sessionStatus').textContent = 'æœªå¼€å§‹';
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('takeBreakBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                sessionStartTime = null;
            }
            
            // æ›´æ–°ä¼šè¯é…ç½®ä¿¡æ¯
            if (status.session_config) {
                currentSession = status.session_config;
                document.getElementById('targetTime').textContent = 
                    `${currentSession.min_duration}:00 ~ ${currentSession.max_duration}:00`;
            }
            
            // ä¼˜å…ˆä½¿ç”¨åç«¯æä¾›çš„æ—¶é•¿æ•°æ®
            if (status.status && status.status.duration !== undefined) {
                updateElapsedTime(status.status.duration);
            }
            
            // æ›´æ–°çŠ¶æ€æ•°æ®
            if (status.status) {
                // æ›´æ–°ä¸“æ³¨åº¦
                const attentionPercent = Math.round((status.status.attention || 0) * 100);
                document.getElementById('attentionValue').textContent = attentionPercent + '%';
                document.getElementById('attentionBar').style.width = attentionPercent + '%';
                
                // æ›´æ–°å‹åŠ›
                const stressPercent = Math.round((status.status.stress || 0) * 100);
                document.getElementById('stressValue').textContent = stressPercent + '%';
                document.getElementById('stressBar').style.width = stressPercent + '%';
                
                // æ›´æ–°ä¸“æ³¨è¯„åˆ†ï¼ˆåŸºäºæ³¨æ„åŠ›å’Œå‹åŠ›è®¡ç®—ç»¼åˆè¯„åˆ†ï¼‰
                const focusScore = Math.round(((status.status.attention || 0) * 0.7 + (1 - (status.status.stress || 0)) * 0.3) * 100);
                document.getElementById('focusScore').textContent = focusScore + '%';
            }
        }
        
        // ç»Ÿä¸€çš„æ—¶é—´æ›´æ–°å‡½æ•°
        function updateElapsedTime(durationInSeconds) {
            const duration = Math.floor(durationInSeconds);
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;
            
            document.getElementById('elapsedTime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°å›¾è¡¨ - åŒ¹é…åç«¯æ•°æ®æ ¼å¼
        function updateChart(eegData) {
            if (!eegData || eegData.length === 0) return;
            
            // æ˜¾ç¤ºæœ€è¿‘30ä¸ªæ•°æ®ç‚¹
            const maxPoints = 30;
            const recentData = eegData.slice(-maxPoints);
            
            const t7Data = recentData.map(d => d.T7);
            const t8Data = recentData.map(d => d.T8);
            const labels = recentData.map((d, i) => i);
            
            eegChart.data.labels = labels;
            eegChart.data.datasets[0].data = t7Data;
            eegChart.data.datasets[1].data = t8Data;
            eegChart.update('none');
        }
        
        // æ›´æ–°æŒ‡æ ‡ - åŒ¹é…åç«¯æ•°æ®æ ¼å¼å¹¶æ·»åŠ è¶‹åŠ¿åˆ†æ
        function updateMetrics(metricsData) {
            if (!metricsData || metricsData.length === 0) return;
            
            const latest = metricsData[metricsData.length - 1];
            
            // æ›´æ–°ä¸“æ³¨åº¦
            const attentionPercent = Math.round((latest.attention || 0) * 100);
            document.getElementById('attentionValue').textContent = attentionPercent + '%';
            document.getElementById('attentionBar').style.width = attentionPercent + '%';
            
            // æ›´æ–°å‹åŠ›
            const stressPercent = Math.round((latest.stress || 0) * 100);
            document.getElementById('stressValue').textContent = stressPercent + '%';
            document.getElementById('stressBar').style.width = stressPercent + '%';
            
            // æ›´æ–°ä¸“æ³¨è¯„åˆ†
            const focusScore = Math.round(((latest.attention || 0) * 0.7 + (1 - (latest.stress || 0)) * 0.3) * 100);
            document.getElementById('focusScore').textContent = focusScore + '%';
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºè¶‹åŠ¿
            updateTrends(metricsData);
            
            // æ›´æ–°è®¤çŸ¥æŒ‡æ ‡å›¾è¡¨
            updateMetricsChart(metricsData);
        }
        
        // æ–°å¢ï¼šæ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
        function updateTrends(metricsData) {
            if (metricsData.length < 10) return; // éœ€è¦è¶³å¤Ÿçš„æ•°æ®ç‚¹
            
            const recent = metricsData.slice(-10);
            const older = metricsData.slice(-20, -10);
            
            if (older.length === 0) return;
            
            // è®¡ç®—æ³¨æ„åŠ›è¶‹åŠ¿
            const recentAttention = recent.reduce((sum, d) => sum + (d.attention || 0), 0) / recent.length;
            const olderAttention = older.reduce((sum, d) => sum + (d.attention || 0), 0) / older.length;
            const attentionTrend = recentAttention - olderAttention;
            
            // è®¡ç®—å‹åŠ›è¶‹åŠ¿
            const recentStress = recent.reduce((sum, d) => sum + (d.stress || 0), 0) / recent.length;
            const olderStress = older.reduce((sum, d) => sum + (d.stress || 0), 0) / older.length;
            const stressTrend = recentStress - olderStress;
            
            // æ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
            document.getElementById('attentionTrend').textContent = 
                attentionTrend > 0.05 ? 'â†—ï¸ ä¸Šå‡' : 
                attentionTrend < -0.05 ? 'â†˜ï¸ ä¸‹é™' : 'â¡ï¸ ç¨³å®š';
                
            document.getElementById('stressTrend').textContent = 
                stressTrend > 0.05 ? 'â†—ï¸ ä¸Šå‡' : 
                stressTrend < -0.05 ? 'â†˜ï¸ ä¸‹é™' : 'â¡ï¸ ç¨³å®š';
        }
        
        // æ–°å¢ï¼šæ›´æ–°è®¤çŸ¥æŒ‡æ ‡å›¾è¡¨
        function updateMetricsChart(metricsData) {
            if (!window.metricsChart || metricsData.length === 0) return;
            
            // æ˜¾ç¤ºæœ€è¿‘60ä¸ªæ•°æ®ç‚¹ï¼ˆçº¦1åˆ†é’Ÿï¼‰
            const maxPoints = 60;
            const recentData = metricsData.slice(-maxPoints);
            
            const labels = recentData.map((d, i) => i);
            const attentionData = recentData.map(d => d.attention || 0);
            const stressData = recentData.map(d => d.stress || 0);
            
            window.metricsChart.data.labels = labels;
            window.metricsChart.data.datasets[0].data = attentionData;
            window.metricsChart.data.datasets[1].data = stressData;
            window.metricsChart.update('none');
        }
        
        // æ›´æ–°é€šçŸ¥
        function updateNotifications(newNotifications) {
            if (!newNotifications) return;
            
            // åˆå¹¶æ–°é€šçŸ¥
            notifications = [...notifications, ...newNotifications];
            
            const notificationsList = document.getElementById('notificationsList');
            
            // æ˜¾ç¤ºæœ€æ–°10æ¡é€šçŸ¥
            const recentNotifications = notifications.slice(-10);
            notificationsList.innerHTML = '';
            
            recentNotifications.forEach(notification => {
                const notificationEl = document.createElement('div');
                notificationEl.className = `notification ${notification.type || 'info'}`;
                
                const timeText = new Date(notification.timestamp * 1000).toLocaleTimeString();
                
                notificationEl.innerHTML = `
                    <div class="notification-time">${timeText}</div>
                    <div>${notification.message}</div>
                `;
                
                notificationsList.appendChild(notificationEl);
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            notificationsList.scrollTop = notificationsList.scrollHeight;
        }
        
        // ä¼šè¯æ§åˆ¶å‡½æ•° - æ·»åŠ ç¼ºå¤±çš„APIè°ƒç”¨
        function pauseSession() {
            fetch('/api/pause_session', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('pauseBtn').style.display = 'none';
                        document.getElementById('resumeBtn').style.display = 'block';
                        showMessage('ä¼šè¯å·²æš‚åœ', 'info');
                    } else {
                        showMessage('æš‚åœå¤±è´¥: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('æš‚åœå¤±è´¥: ' + error.message, 'error');
                });
        }
        
        function resumeSession() {
            fetch('/api/resume_session', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('pauseBtn').style.display = 'block';
                        document.getElementById('resumeBtn').style.display = 'none';
                        showMessage('ä¼šè¯å·²æ¢å¤', 'success');
                    } else {
                        showMessage('æ¢å¤å¤±è´¥: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('æ¢å¤å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        function stopSession() {
            if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰ä¼šè¯å—ï¼Ÿ')) {
                fetch('/api/stop_session', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('ä¼šè¯å·²åœæ­¢', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showMessage('åœæ­¢å¤±è´¥: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showMessage('åœæ­¢å¤±è´¥: ' + error.message, 'error');
                    });
            }
        }
        
        function takeBreak() {
            const duration = prompt('è¯·è¾“å…¥ä¼‘æ¯æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰:', '5');
            if (duration && !isNaN(duration)) {
                fetch('/api/take_break', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: parseInt(duration) })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('ä¼‘æ¯è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                });
            }
        }
        
        // éŸ³ä¹æ§åˆ¶å‡½æ•° - æ·»åŠ ç¼ºå¤±çš„APIè°ƒç”¨
        function startMusic() {
            fetch('/api/start_music', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('éŸ³ä¹æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        function stopMusic() {
            fetch('/api/stop_music', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('éŸ³ä¹åœæ­¢å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        function updateVolume() {
            const volume = document.getElementById('volumeSlider').value;
            document.getElementById('volumeLevel').textContent = volume + '%';
        }
        
        // å·¥å…·å‡½æ•°
        function showMessage(message, type) {
            // æ·»åŠ æ¶ˆæ¯åˆ°é€šçŸ¥åˆ—è¡¨
            const notification = {
                message: message,
                type: type,
                timestamp: Date.now() / 1000
            };
            updateNotifications([notification]);
        }
        
        function updateTimer() {
            if (sessionStartTime) {
                const now = new Date();
                const elapsed = Math.floor((now - sessionStartTime) / 1000);
                
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('elapsedTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Socket.IO äº‹ä»¶å¤„ç† - ä½¿ç”¨åç«¯å®é™…çš„äº‹ä»¶åç§°
        socket.on('connect', function() {
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionText').textContent = 'âœ… å·²è¿æ¥';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionText').textContent = 'âŒ è¿æ¥æ–­å¼€';
        });
        
        // ä¿®æ”¹äº‹ä»¶åç§°ä»¥åŒ¹é…åç«¯
        socket.on('data_update', function(data) {
            updateChart(data.eeg_data);
            updateMetrics(data.metrics_data);
            
            // å¤„ç†ä¼‘æ¯å»ºè®®
            if (data.break_suggestion) {
                updateBreakSuggestion(data.break_suggestion);
            }
            
            // å¤„ç†éŸ³ä¹æ¨è
            if (data.music_status) {
                updateMusicRecommendation(data.music_status);
            }
            
            // å¤„ç†çŠ¶æ€æ›´æ–°
            if (data.status) {
                // æ›´æ–°ä¼šè¯æ—¶é•¿
                if (data.status.duration) {
                    updateElapsedTime(data.status.duration);
                }
            }
        });
        
        // æ–°å¢ï¼šæ›´æ–°ä¼‘æ¯å»ºè®®æ˜¾ç¤º
        function updateBreakSuggestion(suggestion) {
            const breakContent = document.getElementById('breakContent');
            
            if (suggestion) {
                const urgencyClass = suggestion.urgency >= 4 ? 'high-urgency' : 
                                   suggestion.urgency >= 3 ? 'medium-urgency' : 'low-urgency';
                
                breakContent.innerHTML = `
                    <div class="break-recommendation ${urgencyClass}">
                        <div class="break-type">ğŸ’¡ ${getBreakTypeText(suggestion.type)}</div>
                        <div class="break-duration">â±ï¸ å»ºè®®æ—¶é•¿: ${suggestion.duration} åˆ†é’Ÿ</div>
                        <div class="break-reason">ğŸ“‹ åŸå› : ${suggestion.reason}</div>
                        <div class="break-urgency">âš ï¸ ç´§æ€¥ç¨‹åº¦: ${suggestion.urgency}/5</div>
                        <div class="break-activities">
                            <strong>å»ºè®®æ´»åŠ¨:</strong>
                            <ul>
                                ${suggestion.activities.map(activity => `<li>${activity}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="break-confidence">å¯ä¿¡åº¦: ${(suggestion.confidence * 100).toFixed(0)}%</div>
                        <button class="btn btn-warning" onclick="acceptBreakSuggestion(${suggestion.duration})">
                            æ¥å—å»ºè®®
                        </button>
                    </div>
                `;
                
                // æ·»åŠ é€šçŸ¥
                showMessage(`ğŸ’¡ ä¼‘æ¯å»ºè®®: ${suggestion.reason}`, 'break_suggestion');
            }
        }
        
        // æ–°å¢ï¼šè·å–ä¼‘æ¯ç±»å‹æ–‡æœ¬
        function getBreakTypeText(type) {
            const typeMap = {
                'micro_break': 'å¾®ä¼‘æ¯',
                'short_break': 'çŸ­ä¼‘æ¯', 
                'long_break': 'é•¿ä¼‘æ¯',
                'power_nap': 'å°æ†©'
            };
            return typeMap[type] || type;
        }
        
        // æ–°å¢ï¼šæ¥å—ä¼‘æ¯å»ºè®®
        function acceptBreakSuggestion(duration) {
            if (confirm(`ç¡®å®šè¦ä¼‘æ¯ ${duration} åˆ†é’Ÿå—ï¼Ÿ`)) {
                fetch('/api/take_break', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: duration })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('ä¼‘æ¯è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                });
            }
        }
        
        // æ–°å¢ï¼šæ›´æ–°éŸ³ä¹æ¨èæ˜¾ç¤º
        function updateMusicRecommendation(musicStatus) {
            if (musicStatus && musicStatus.recommendation) {
                const recommendation = musicStatus.recommendation;
                
                document.getElementById('musicTrack').textContent = 
                    recommendation.tracks && recommendation.tracks.length > 0 ? 
                    recommendation.tracks[0].title : 'æš‚æ— æ¨è';
                    
                document.getElementById('musicArtist').textContent = 
                    recommendation.tracks && recommendation.tracks.length > 0 ? 
                    recommendation.tracks[0].artist : '';
                    
                document.getElementById('musicReason').textContent = 
                    recommendation.reason || '';
                
                // æ›´æ–°æ¨èéŸ³é‡
                if (recommendation.adaptive_volume !== undefined) {
                    const volumePercent = Math.round(recommendation.adaptive_volume * 100);
                    document.getElementById('volumeSlider').value = volumePercent;
                    document.getElementById('volumeLevel').textContent = volumePercent + '%';
                }
            }
        }
        
        // æ–°å¢ï¼šæ¥å—ä¼‘æ¯å»ºè®®
        function acceptBreakSuggestion(duration) {
            if (confirm(`ç¡®å®šè¦ä¼‘æ¯ ${duration} åˆ†é’Ÿå—ï¼Ÿ`)) {
                fetch('/api/take_break', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: duration })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                })
                .catch(error => {
                    showMessage('ä¼‘æ¯è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                });
            }
        }
        
        // å®šæ—¶å™¨
        setInterval(updateTimer, 1000);
        setInterval(loadStatus, 30000); // æ¯30ç§’åˆ·æ–°çŠ¶æ€
    </script>
</body>
</html>