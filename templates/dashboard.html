<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§  EEGå®æ—¶ç›‘æ§ä»ªè¡¨æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-transform: uppercase;
        }

        .btn-start {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .btn-stop {
            background: linear-gradient(45deg, #f44336, #da190b);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .status-panel {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .status-item {
            padding: 10px;
        }

        .status-label {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.4em;
            font-weight: bold;
        }

        /* ä¼˜åŒ–åçš„å›¾è¡¨å®¹å™¨ - æ›´ç´§å‡‘ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .chart-panel {
            background: rgba(255,255,255,0.95);
            padding: 12px;
            border-radius: 12px;
            color: #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.0em;
            font-weight: bold;
        }

        /* å…³é”®ä¼˜åŒ–ï¼šé™ä½å›¾è¡¨é«˜åº¦ */
        .chart-canvas {
            width: 100%;
            height: 180px !important; /* ä»250pxé™ä½åˆ°180px */
        }

        .metrics-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .metric-title {
            font-size: 1.0em;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .metric-bar {
            width: 100%;
            height: 18px;
            background: rgba(255,255,255,0.2);
            border-radius: 9px;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 9px;
        }

        .attention-fill {
            background: linear-gradient(90deg, #4CAF50, #81C784);
        }

        .stress-fill {
            background: linear-gradient(90deg, #FF9800, #FFB74D);
        }

        .connection-indicator {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .metrics-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }

            .chart-canvas {
                height: 150px !important; /* ç§»åŠ¨ç«¯æ›´å° */
            }
        }
    </style>
</head>
<body>
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-indicator disconnected" id="connectionStatus">
        <span id="connectionText">è¿æ¥ä¸­...</span>
    </div>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ§  EEGå®æ—¶ç›‘æ§ä»ªè¡¨æ¿</h1>
            <p>EMOTIVè„‘ç”µæ³¢æ•°æ®å®æ—¶å¯è§†åŒ–</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <button class="btn btn-start" onclick="startMonitoring()">
                ğŸš€ å¼€å§‹ç›‘æ§
            </button>
            <button class="btn btn-stop" onclick="stopMonitoring()">
                ğŸ›‘ åœæ­¢ç›‘æ§
            </button>
        </div>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <h3 style="text-align: center; margin-bottom: 15px; font-size: 1.1em;">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">ä¼šè¯æ—¶é•¿</div>
                    <div class="status-value" id="sessionDuration">00:00:00</div>
                </div>
                <div class="status-item">
                    <div class="status-label">EEGæ•°æ®åŒ…</div>
                    <div class="status-value" id="eegCount">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æŒ‡æ ‡æ•°æ®åŒ…</div>
                    <div class="status-value" id="metricsCount">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ•°æ®é€Ÿç‡</div>
                    <div class="status-value" id="dataRate">0 Hz</div>
                </div>
            </div>
        </div>

        <!-- ä¼˜åŒ–åçš„å›¾è¡¨å®¹å™¨ -->
        <div class="charts-container">
            <div class="chart-panel">
                <div class="chart-title">ğŸ§  T7ç”µææ³¢å½¢ (å·¦è„‘)</div>
                <canvas class="chart-canvas" id="t7Chart"></canvas>
            </div>
            <div class="chart-panel">
                <div class="chart-title">ğŸ§  T8ç”µææ³¢å½¢ (å³è„‘)</div>
                <canvas class="chart-canvas" id="t8Chart"></canvas>
            </div>
        </div>

        <!-- è®¤çŸ¥æŒ‡æ ‡ -->
        <div class="metrics-container">
            <div class="metric-card">
                <div class="metric-title">ğŸ¯ ä¸“æ³¨åº¦ç›‘æ§</div>
                <div class="metric-value" id="attentionValue">0%</div>
                <div class="metric-bar">
                    <div class="metric-fill attention-fill" id="attentionBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-title">âš¡ è®¤çŸ¥å‹åŠ›</div>
                <div class="metric-value" id="stressValue">0%</div>
                <div class="metric-bar">
                    <div class="metric-fill stress-fill" id="stressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // åˆå§‹åŒ–Socket.IOè¿æ¥
        const socket = io();
        
        // å›¾è¡¨å˜é‡
        let t7Chart, t8Chart;
        let sessionStartTime = null;
        let isMonitoring = false;
        
        // ä¼˜åŒ–åçš„å›¾è¡¨åˆå§‹åŒ– - æ˜¾ç¤ºæ›´çŸ­çš„æ—¶é—´çª—å£
        function initCharts() {
            const chartConfig = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderWidth: 1.5, // ç¨å¾®ç»†ä¸€ç‚¹çš„çº¿æ¡
                        fill: true,
                        tension: 0.3, // æ›´å¹³æ»‘çš„æ›²çº¿
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            display: false 
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Î¼V',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    animation: false,
                    // ä¼˜åŒ–æ€§èƒ½
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            };
            
            // T7å›¾è¡¨ (ç»¿è‰²)
            const t7Config = JSON.parse(JSON.stringify(chartConfig));
            t7Config.data.datasets[0].borderColor = '#4CAF50';
            t7Config.data.datasets[0].backgroundColor = 'rgba(76, 175, 80, 0.15)';
            t7Chart = new Chart(document.getElementById('t7Chart'), t7Config);
            
            // T8å›¾è¡¨ (æ©™è‰²)
            const t8Config = JSON.parse(JSON.stringify(chartConfig));
            t8Config.data.datasets[0].borderColor = '#FF5722';
            t8Config.data.datasets[0].backgroundColor = 'rgba(255, 87, 34, 0.15)';
            t8Chart = new Chart(document.getElementById('t8Chart'), t8Config);
        }
        
        // ä¼˜åŒ–åçš„å›¾è¡¨æ›´æ–° - æ˜¾ç¤ºæ›´çŸ­çš„æ—¶é—´çª—å£
        function updateCharts(eegData) {
            if (eegData.length === 0) return;
            
            // å…³é”®ä¼˜åŒ–ï¼šå‡å°‘æ˜¾ç¤ºçš„æ•°æ®ç‚¹æ•°é‡ï¼Œè®©æ³¢å½¢æ›´ç´§å‡‘
            const maxPoints = 30; // ä»100å‡å°‘åˆ°30ä¸ªç‚¹ï¼Œæ˜¾ç¤ºæ›´çŸ­çš„æ—¶é—´çª—å£
            
            // æå–æœ€æ–°çš„æ•°æ®
            const recentData = eegData.slice(-maxPoints);
            const t7Data = recentData.map(d => d.T7);
            const t8Data = recentData.map(d => d.T8);
            const labels = recentData.map((d, i) => i);
            
            // æ›´æ–°T7å›¾è¡¨
            t7Chart.data.labels = labels;
            t7Chart.data.datasets[0].data = t7Data;
            t7Chart.update('none');
            
            // æ›´æ–°T8å›¾è¡¨
            t8Chart.data.labels = labels;
            t8Chart.data.datasets[0].data = t8Data;
            t8Chart.update('none');
        }
        
        // æ›´æ–°è®¤çŸ¥æŒ‡æ ‡
        function updateMetrics(metricsData) {
            if (metricsData.length === 0) return;
            
            const latest = metricsData[metricsData.length - 1];
            
            // æ›´æ–°ä¸“æ³¨åº¦
            const attentionPercent = (latest.attention * 100).toFixed(1);
            document.getElementById('attentionValue').textContent = attentionPercent + '%';
            document.getElementById('attentionBar').style.width = attentionPercent + '%';
            
            // æ›´æ–°å‹åŠ›
            const stressPercent = (latest.stress * 100).toFixed(1);
            document.getElementById('stressValue').textContent = stressPercent + '%';
            document.getElementById('stressBar').style.width = stressPercent + '%';
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status) {
            // æ›´æ–°è®¡æ•°å™¨
            document.getElementById('eegCount').textContent = status.eeg_count || 0;
            document.getElementById('metricsCount').textContent = status.metrics_count || 0;
            
            // è®¡ç®—å’Œæ˜¾ç¤ºæ•°æ®é€Ÿç‡
            const duration = status.duration || 1;
            const eegRate = ((status.eeg_count || 0) / duration).toFixed(1);
            document.getElementById('dataRate').textContent = eegRate + ' Hz';
            
            // æ›´æ–°ä¼šè¯æ—¶é•¿
            if (isMonitoring && sessionStartTime) {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionDuration').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Socketäº‹ä»¶å¤„ç†
        socket.on('connect', function() {
            document.getElementById('connectionStatus').className = 'connection-indicator connected';
            document.getElementById('connectionText').textContent = 'âœ… å·²è¿æ¥';
            console.log('WebSocketè¿æ¥æˆåŠŸ');
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').className = 'connection-indicator disconnected';
            document.getElementById('connectionText').textContent = 'âŒ è¿æ¥æ–­å¼€';
            console.log('WebSocketè¿æ¥æ–­å¼€');
        });
        
        socket.on('data_update', function(data) {
            updateCharts(data.eeg_data);
            updateMetrics(data.metrics_data);
            updateStatus(data.status);
        });
        
        socket.on('status_update', function(data) {
            isMonitoring = data.running;
            if (data.running && !sessionStartTime) {
                sessionStartTime = Date.now();
            } else if (!data.running) {
                sessionStartTime = null;
            }
        });
        
        // æ§åˆ¶å‡½æ•° - æ·»åŠ çŠ¶æ€æ£€æŸ¥
        function startMonitoring() {
            // å…ˆæ£€æŸ¥å½“å‰çŠ¶æ€ï¼Œé¿å…é‡å¤å¯åŠ¨
            fetch('/api/status')
                .then(response => response.json())
                .then(statusData => {
                    if (statusData.running) {
                        alert('âš ï¸ ç›‘æ§å·²ç»åœ¨è¿è¡Œä¸­ï¼');
                        return;
                    }
                    
                    // å¯åŠ¨ç›‘æ§
                    fetch('/api/start')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                sessionStartTime = Date.now();
                                isMonitoring = true;
                                alert('ğŸš€ ç›‘æ§å·²å¯åŠ¨ï¼');
                                console.log('ç›‘æ§å¯åŠ¨æˆåŠŸ');
                            } else {
                                alert('âŒ å¯åŠ¨å¤±è´¥ï¼š' + data.message);
                                console.error('ç›‘æ§å¯åŠ¨å¤±è´¥:', data.message);
                            }
                        })
                        .catch(error => {
                            alert('âŒ å¯åŠ¨é”™è¯¯ï¼š' + error);
                            console.error('å¯åŠ¨é”™è¯¯:', error);
                        });
                })
                .catch(error => {
                    console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        function stopMonitoring() {
            fetch('/api/stop')
                .then(response => response.json())
                .then(data => {
                    sessionStartTime = null;
                    isMonitoring = false;
                    alert('ğŸ›‘ ç›‘æ§å·²åœæ­¢ï¼');
                    console.log('ç›‘æ§åœæ­¢æˆåŠŸ');
                })
                .catch(error => {
                    alert('âŒ åœæ­¢é”™è¯¯ï¼š' + error);
                    console.error('åœæ­¢é”™è¯¯:', error);
                });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å›¾è¡¨...');
            initCharts();
            
            // å®šæ—¶æ›´æ–°ä¼šè¯æ—¶é•¿æ˜¾ç¤º
            setInterval(function() {
                if (isMonitoring && sessionStartTime) {
                    const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('sessionDuration').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        });
    </script>
</body>
</html>